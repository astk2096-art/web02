<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Prity - Author & Scholar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        h1, h2, h3 {
            font-family: 'Lora', serif;
        }
        .editable-outline {
            outline: 2px dashed rgba(37, 99, 235, 0.5);
            transition: all 0.3s ease-in-out;
            border-radius: 8px;
        }
        .editable-outline:hover {
            outline: 2px solid rgba(37, 99, 235, 1);
            background-color: rgba(239, 246, 255, 0.7);
        }
        .edit-btn, .add-btn, .delete-btn {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .editable-container:hover .edit-btn,
        .editable-container:hover .add-btn,
        .editable-container:hover .delete-btn {
            opacity: 1;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .tab-btn.active {
            border-bottom-color: #2563eb; /* blue-600 */
            color: #2563eb;
        }
    </style>
</head>
<body class="text-slate-700">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div id="header-title" class="text-2xl font-bold text-slate-800 tracking-tight">
                </div>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#about" class="hover:text-blue-600">About</a>
                <a href="#books" class="hover:text-blue-600">Books</a>
                <a href="#publications" class="hover:text-blue-600">Publications</a>
                <a href="#contact" class="hover:text-blue-600">Contact</a>
            </div>
            <div id="auth-container" class="flex items-center space-x-2">
                <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
                <button id="signup-btn" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">Sign Up</button>
                <button id="logout-btn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Logout</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <section id="hero" class="text-center py-20">
            </section>

        <section id="about" class="py-20 scroll-mt-20">
            <h2 class="text-4xl font-bold text-center mb-12 text-slate-800">About Me</h2>
            <div id="about-content" class="grid md:grid-cols-3 gap-12 items-center">
                 </div>
        </section>

        <section id="books" class="py-20 scroll-mt-20 bg-slate-100 -mx-6 px-6">
            <div class="container mx-auto">
                <div class="flex justify-center items-center mb-12">
                     <h2 class="text-4xl font-bold text-center text-slate-800">Published Books</h2>
                     <div id="add-book-container" class="ml-4"></div>
                </div>
                <div id="books-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
            </div>
        </section>

        <section id="publications" class="py-20 scroll-mt-20">
             <div class="flex justify-center items-center mb-12">
                <h2 class="text-4xl font-bold text-center text-slate-800">Research & Publications</h2>
                <div id="add-publication-container" class="ml-4"></div>
             </div>
            <div id="publications-list" class="max-w-4xl mx-auto space-y-6">
                 </div>
        </section>

        <section id="contact" class="py-20 scroll-mt-20 bg-slate-800 text-white -mx-6 px-6">
            <div class="container mx-auto text-center">
                 <h2 class="text-4xl font-bold text-center mb-8">Get In Touch</h2>
                 <div id="contact-content">
                    </div>
            </div>
        </section>
    </main>

    <footer class="bg-white py-6">
        <div class="container mx-auto text-center text-slate-500">
            <p>&copy; <span id="footer-year"></span> <span id="footer-name"></span> All rights reserved.</p>
        </div>
    </footer>

    <div id="auth-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 m-4">
            <div class="flex border-b">
                <button id="login-tab" class="flex-1 p-4 font-semibold border-b-2 tab-btn active">Login</button>
                <button id="signup-tab" class="flex-1 p-4 font-semibold border-b-2 tab-btn">Sign Up</button>
            </div>
            <div class="p-8">
                <form id="login-form">
                    <h3 class="text-2xl font-bold mb-6 text-center">Author Login</h3>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-slate-600 mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Login</button>
                </form>
                <form id="signup-form" class="hidden">
                    <h3 class="text-2xl font-bold mb-6 text-center">Author Registration</h3>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-slate-600 mb-1">Email</label>
                        <input type="email" id="signup-email" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-password" class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                        <input type="password" id="signup-password" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required placeholder="At least 6 characters">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password-confirm" class="block text-sm font-medium text-slate-600 mb-1">Confirm Password</label>
                        <input type="password" id="signup-password-confirm" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <p id="signup-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Sign Up</button>
                </form>
            </div>
            <button id="close-auth-modal" class="absolute top-2 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl z-10 m-4 max-h-[90vh] overflow-y-auto">
            <h3 id="edit-modal-title" class="text-2xl font-bold mb-6">Edit Section</h3>
            <form id="edit-form">
                <div id="edit-form-fields" class="space-y-4">
                    </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="close-edit-modal" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        <p id="toast-message">Saved successfully!</p>
    </div>

    <script type="module">
        // Firebase Imports
       

       










 // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBY4Y--BlL5yGLXVmeSKi3B_wYoNmtfDiQ",
    authDomain: "website-5397e.firebaseapp.com",
    projectId: "website-5397e",
    storageBucket: "website-5397e.firebasestorage.app",
    messagingSenderId: "201909860812",
    appId: "1:201909860812:web:eac1d32d2dd738a612c569",
    measurementId: "G-PFKMQ5NRWF"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // Your analytics initialization
    const auth = getAuth(app);
    const db = getFirestore(app);













        const contentRef = doc(db, `artifacts/${appId}/public/data/websiteContent`, "main");

        let websiteContent = {};
        let isLoggedIn = false;
        const AUTHOR_EMAILS = ["prity101195@gmail.com"];
        let currentEditContext = null;

        // Default content structure
        const defaultContent = {
            headerTitle: "Prof. Prity",
            hero: {
                title: "Exploring the Frontiers of Knowledge",
                subtitle: "Author, Educator, and Researcher",
                imageUrl: "https://placehold.co/1200x400/a3e635/1e293b?text=Welcome"
            },
            about: {
                imageUrl: "https://placehold.co/400x400/60a5fa/ffffff?text=Prof.+Prity",
                text: "An engaging and detailed biography about the professor's journey, research interests, teaching philosophy, and personal passions. This text can be edited to reflect accomplishments and updates in their career."
            },
            books: [
                {
                    id: "book1",
                    title: "The First Chapter",
                    description: "A summary of the first book, covering its main themes, purpose, and intended audience.",
                    imageUrl: "https://placehold.co/400x600/f9a8d4/1e293b?text=Book+Cover",
                    links: [
                        { id: "link1", name: "Amazon", url: "#" },
                        { id: "link2", name: "Publisher", url: "#" }
                    ]
                }
            ],
            publications: [
                {
                    id: "pub1",
                    title: "Foundational Theories in Modern Science",
                    journal: "Journal of Academic Research, Vol. 1, Issue 1",
                    url: "#"
                }
            ],
            contact: {
                email: "prity101195@gmail.com",
                phone: "+91-7292870275"
            }
        };

        // --- UTILITY FUNCTIONS ---
        const $ = (selector, parent = document) => parent.querySelector(selector);
        const showToast = (message, isError = false) => {
            const toast = $('#toast');
            $('#toast-message').textContent = message;
            toast.classList.toggle('bg-red-500', isError);
            toast.classList.toggle('bg-green-500', !isError);
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        };

        const createEditButton = (onClick) => {
            const btn = document.createElement('button');
            btn.className = 'edit-btn absolute -top-2 -right-2 bg-blue-600 text-white p-2 rounded-full shadow-lg hover:bg-blue-700 transition-transform hover:scale-110';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>`;
            btn.onclick = onClick;
            return btn;
        };

        const createEditableContainer = (content, onClick) => {
            const container = document.createElement('div');
            container.className = 'relative p-2 editable-container';
            if(isLoggedIn) container.classList.add('editable-outline');
            container.innerHTML = content;
            if (isLoggedIn) {
                container.appendChild(createEditButton(onClick));
            }
            return container;
        };

        // --- RENDERING LOGIC ---
        function renderWebsite() {
            if (!websiteContent || Object.keys(websiteContent).length === 0) return;

            // Header
            $('#header-title').innerHTML = '';
            $('#header-title').appendChild(createEditableContainer(
                `<span class="font-lora">${websiteContent.headerTitle}</span>`,
                () => openEditModal('headerTitle')
            ));

            // Hero
            $('#hero').innerHTML = '';
            $('#hero').appendChild(createEditableContainer(
                `
                    <img src="${websiteContent.hero.imageUrl}" onerror="this.onerror=null; this.src='https://placehold.co/128x128/e2e8f0/475569?text=Img';" class="w-24 h-24 rounded-full mx-auto mb-6 object-cover shadow-lg">
                    <h1 class="text-5xl md:text-6xl font-bold mb-4 text-slate-900">${websiteContent.hero.title}</h1>
                    <p class="text-xl text-slate-600">${websiteContent.hero.subtitle}</p>
                `,
                () => openEditModal('hero')
            ));

            // About
            $('#about-content').innerHTML = '';
            const aboutContainer = document.createElement('div');
            aboutContainer.className = 'relative col-span-1 editable-container';
            if(isLoggedIn) aboutContainer.classList.add('editable-outline');
            aboutContainer.innerHTML = `<img src="${websiteContent.about.imageUrl}" alt="Professor Prity" class="rounded-lg shadow-xl w-full h-auto object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x400/e2e8f0/475569?text=Img';">`;
            if (isLoggedIn) {
                aboutContainer.appendChild(createEditButton(() => openEditModal('aboutImage')));
            }
            $('#about-content').appendChild(aboutContainer);
            $('#about-content').appendChild(createEditableContainer(
                `<p class="text-lg leading-relaxed col-span-2">${websiteContent.about.text.replace(/\n/g, '<br>')}</p>`,
                () => openEditModal('aboutText')
            ));

            // Books
            $('#books-grid').innerHTML = '';
            websiteContent.books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'bg-white p-6 rounded-lg shadow-lg flex flex-col editable-container relative';
                let linksHtml = book.links.map(link => `
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="inline-block bg-slate-200 text-slate-700 px-3 py-1 rounded-full text-sm font-medium hover:bg-slate-300 mr-2 mb-2">${link.name}</a>
                `).join('');

                bookCard.innerHTML = `
                    <img src="${book.imageUrl}" alt="Book cover for ${book.title}" class="rounded-md mb-4 shadow-md aspect-[2/3] object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x600/e2e8f0/475569?text=Cover';">
                    <h3 class="text-2xl font-bold mb-2 text-slate-800">${book.title}</h3>
                    <p class="text-slate-600 mb-4 flex-grow">${book.description}</p>
                    <div>${linksHtml}</div>
                `;
                if(isLoggedIn) {
                    bookCard.classList.add('editable-outline');
                    bookCard.appendChild(createEditButton(() => openEditModal('book', book.id)));
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = `&times;`;
                    deleteBtn.className = 'delete-btn absolute -top-2 -left-2 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-lg';
                    deleteBtn.onclick = () => deleteItem('book', book.id);
                    bookCard.appendChild(deleteBtn);
                }
                $('#books-grid').appendChild(bookCard);
            });
            $('#add-book-container').innerHTML = '';
            if (isLoggedIn) {
                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-transform hover:scale-110';
                addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`;
                addBtn.onclick = () => openEditModal('book', null);
                $('#add-book-container').appendChild(addBtn);
            }

            // Publications
            $('#publications-list').innerHTML = '';
            websiteContent.publications.forEach(pub => {
                const pubItem = document.createElement('div');
                pubItem.className = 'bg-white p-6 rounded-lg shadow-lg editable-container relative';
                pubItem.innerHTML = `
                    <h4 class="text-xl font-semibold text-slate-800 mb-1">${pub.title}</h4>
                    <p class="text-slate-600 mb-2">${pub.journal}</p>
                    <a href="${pub.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Read Full Article &rarr;</a>
                `;
                if (isLoggedIn) {
                    pubItem.classList.add('editable-outline');
                    pubItem.appendChild(createEditButton(() => openEditModal('publication', pub.id)));
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = `&times;`;
                    deleteBtn.className = 'delete-btn absolute -top-2 -left-2 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-lg';
                    deleteBtn.onclick = () => deleteItem('publication', pub.id);
                    pubItem.appendChild(deleteBtn);
                }
                $('#publications-list').appendChild(pubItem);
            });
            $('#add-publication-container').innerHTML = '';
            if (isLoggedIn) {
                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-transform hover:scale-110';
                addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`;
                addBtn.onclick = () => openEditModal('publication', null);
                $('#add-publication-container').appendChild(addBtn);
            }

            // Contact
            $('#contact-content').innerHTML = '';
            $('#contact-content').appendChild(createEditableContainer(
                `<p class="text-lg">Email: <a href="mailto:${websiteContent.contact.email}" class="text-blue-400 hover:underline">${websiteContent.contact.email}</a></p>
                 <p class="text-lg">Phone: <a href="tel:${websiteContent.contact.phone}" class="text-blue-400 hover:underline">${websiteContent.contact.phone}</a></p>`,
                () => openEditModal('contact')
            ));

            // Footer
            $('#footer-year').textContent = new Date().getFullYear();
            $('#footer-name').textContent = websiteContent.headerTitle;
        }

        // --- AUTHENTICATION & SECURITY ---
        onAuthStateChanged(auth, async (user) => {
            isLoggedIn = user && AUTHOR_EMAILS.includes(user.email);
            updateAuthUI();
            renderWebsite();
        });

        function updateAuthUI() {
            const loginBtn = $('#login-btn');
            const signupBtn = $('#signup-btn');
            const logoutBtn = $('#logout-btn');
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // Login/Sign Up Modal Handlers
        $('#login-btn').addEventListener('click', () => {
            $('#auth-modal').classList.remove('hidden');
            $('#login-form').classList.remove('hidden');
            $('#signup-form').classList.add('hidden');
            $('#login-tab').classList.add('active');
            $('#signup-tab').classList.remove('active');
        });

        $('#signup-btn').addEventListener('click', () => {
            $('#auth-modal').classList.remove('hidden');
            $('#login-form').classList.add('hidden');
            $('#signup-form').classList.remove('hidden');
            $('#login-tab').classList.remove('active');
            $('#signup-tab').classList.add('active');
        });

        $('#login-tab').addEventListener('click', () => {
            $('#login-form').classList.remove('hidden');
            $('#signup-form').classList.add('hidden');
            $('#login-tab').classList.add('active');
            $('#signup-tab').classList.remove('active');
        });

        $('#signup-tab').addEventListener('click', () => {
            $('#login-form').classList.add('hidden');
            $('#signup-form').classList.remove('hidden');
            $('#login-tab').classList.remove('active');
            $('#signup-tab').classList.add('active');
        });

        $('#close-auth-modal').addEventListener('click', () => {
            $('#auth-modal').classList.add('hidden');
            $('#login-error').classList.add('hidden');
            $('#signup-error').classList.add('hidden');
        });

        // LOGIN FORM SUBMISSION
        $('#login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = $('#login-email').value;
            const password = $('#login-password').value;
            const errorMsg = $('#login-error');
            errorMsg.classList.add('hidden');
            
            // Check if the user is an authorized author before attempting login
            if (!AUTHOR_EMAILS.includes(email)) {
                errorMsg.textContent = 'You are not authorized to log in as an author.';
                errorMsg.classList.remove('hidden');
                showToast('Login failed: Unauthorized email.', true);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                $('#auth-modal').classList.add('hidden');
                showToast('Login successful!');
            } catch (error) {
                errorMsg.textContent = `Login failed: ${error.message}`;
                errorMsg.classList.remove('hidden');
                showToast('Login failed.', true);
            }
        });

        // SIGNUP FORM SUBMISSION (DISABLED FOR GENERAL USERS)
        $('#signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const errorMsg = $('#signup-error');
            errorMsg.classList.remove('hidden');
            errorMsg.textContent = 'New author registration is not permitted from this page. Please contact the administrator.';
            showToast('Registration is disabled.', true);
        });

        // LOGOUT
        $('#logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Logged out successfully.');
            } catch (error) {
                showToast('Logout failed.', true);
            }
        });

        // --- CONTENT MANAGEMENT ---
        function openEditModal(context, id = null) {
            if (!isLoggedIn) return; // Basic security check
            currentEditContext = { context, id };
            const formFields = $('#edit-form-fields');
            formFields.innerHTML = '';
            $('#edit-modal-title').textContent = `Edit: ${context}`;

            let dataToEdit;
            switch (context) {
                case 'headerTitle':
                    dataToEdit = { headerTitle: websiteContent.headerTitle };
                    createInputField(formFields, 'headerTitle', 'Header Title', dataToEdit.headerTitle);
                    break;
                case 'hero':
                    dataToEdit = websiteContent.hero;
                    createInputField(formFields, 'title', 'Hero Title', dataToEdit.title);
                    createInputField(formFields, 'subtitle', 'Hero Subtitle', dataToEdit.subtitle);
                    createInputField(formFields, 'imageUrl', 'Hero Image URL', dataToEdit.imageUrl);
                    break;
                case 'aboutImage':
                    dataToEdit = { imageUrl: websiteContent.about.imageUrl };
                    createInputField(formFields, 'imageUrl', 'About Image URL', dataToEdit.imageUrl);
                    break;
                case 'aboutText':
                    dataToEdit = { text: websiteContent.about.text };
                    createTextArea(formFields, 'text', 'About Text', dataToEdit.text);
                    break;
                case 'book':
                    dataToEdit = id ? websiteContent.books.find(b => b.id === id) : { id: 'new-' + Date.now(), title: '', description: '', imageUrl: '', links: [{ id: 'link1', name: 'Amazon', url: '#' }] };
                    createInputField(formFields, 'title', 'Book Title', dataToEdit.title);
                    createTextArea(formFields, 'description', 'Description', dataToEdit.description);
                    createInputField(formFields, 'imageUrl', 'Cover Image URL', dataToEdit.imageUrl);

                    const linksContainer = document.createElement('div');
                    linksContainer.id = 'links-container';
                    linksContainer.className = 'space-y-2 mt-4 p-4 border border-slate-200 rounded-md';
                    linksContainer.innerHTML = '<label class="block text-sm font-medium text-slate-600">Purchase Links</label>';
                    dataToEdit.links.forEach(link => createLinkField(linksContainer, link));
                    formFields.appendChild(linksContainer);

                    const addLinkBtn = document.createElement('button');
                    addLinkBtn.type = 'button';
                    addLinkBtn.className = 'mt-2 bg-slate-200 text-slate-700 px-3 py-1 rounded-md text-sm hover:bg-slate-300';
                    addLinkBtn.textContent = 'Add Link';
                    addLinkBtn.onclick = () => createLinkField(linksContainer, { id: 'link-' + Date.now(), name: '', url: '' });
                    formFields.appendChild(addLinkBtn);

                    break;
                case 'publication':
                    dataToEdit = id ? websiteContent.publications.find(p => p.id === id) : { id: 'new-' + Date.now(), title: '', journal: '', url: '' };
                    createInputField(formFields, 'title', 'Publication Title', dataToEdit.title);
                    createInputField(formFields, 'journal', 'Journal/Source', dataToEdit.journal);
                    createInputField(formFields, 'url', 'Article URL', dataToEdit.url);
                    break;
                case 'contact':
                    dataToEdit = websiteContent.contact;
                    createInputField(formFields, 'email', 'Email Address', dataToEdit.email);
                    createInputField(formFields, 'phone', 'Phone Number', dataToEdit.phone);
                    break;
            }

            $('#edit-modal').classList.remove('hidden');
        }

        function createInputField(parent, id, label, value) {
            const div = document.createElement('div');
            div.className = 'mb-4';
            div.innerHTML = `
                <label for="${id}" class="block text-sm font-medium text-slate-600 mb-1">${label}</label>
                <input type="text" id="${id}" name="${id}" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" value="${value || ''}" required>
            `;
            parent.appendChild(div);
        }

        function createTextArea(parent, id, label, value) {
            const div = document.createElement('div');
            div.className = 'mb-4';
            div.innerHTML = `
                <label for="${id}" class="block text-sm font-medium text-slate-600 mb-1">${label}</label>
                <textarea id="${id}" name="${id}" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500 h-32" required>${value || ''}</textarea>
            `;
            parent.appendChild(div);
        }

        function createLinkField(parent, link) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Link Name" class="link-name-input px-3 py-2 border border-slate-300 rounded-md w-1/3" value="${link.name}" required>
                <input type="url" placeholder="URL" class="link-url-input px-3 py-2 border border-slate-300 rounded-md w-2/3" value="${link.url}" required>
                <button type="button" class="remove-link-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
            `;
            div.querySelector('.remove-link-btn').onclick = () => div.remove();
            parent.appendChild(div);
        }

        $('#close-edit-modal').addEventListener('click', () => {
            $('#edit-modal').classList.add('hidden');
        });

        // Save Changes to Firestore
        $('#edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { context, id } = currentEditContext;
            let dataToSave = {};
            const formData = new FormData(e.target);

            // Collect data based on the context
            switch (context) {
                case 'headerTitle':
                    dataToSave = { headerTitle: formData.get('headerTitle') };
                    break;
                case 'hero':
                    dataToSave = { hero: {
                        title: formData.get('title'),
                        subtitle: formData.get('subtitle'),
                        imageUrl: formData.get('imageUrl')
                    }};
                    break;
                case 'aboutImage':
                    dataToSave = { about: { ...websiteContent.about, imageUrl: formData.get('imageUrl') }};
                    break;
                case 'aboutText':
                    dataToSave = { about: { ...websiteContent.about, text: formData.get('text') }};
                    break;
                case 'contact':
                    dataToSave = { contact: {
                        email: formData.get('email'),
                        phone: formData.get('phone')
                    }};
                    break;
                case 'book':
                case 'publication':
                    const item = {
                        id: id || 'new-' + Date.now(),
                        title: formData.get('title'),
                        ...(context === 'book' ? {
                            description: formData.get('description'),
                            imageUrl: formData.get('imageUrl'),
                            links: Array.from($('#links-container').children).slice(1).map(div => ({
                                id: 'link-' + Date.now(),
                                name: div.querySelector('.link-name-input').value,
                                url: div.querySelector('.link-url-input').value
                            }))
                        } : {
                            journal: formData.get('journal'),
                            url: formData.get('url')
                        })
                    };

                    const collectionName = context === 'book' ? 'books' : 'publications';
                    if (id && id.startsWith('new-')) { // Handle new items that were not yet saved
                         dataToSave[collectionName] = [...websiteContent[collectionName], item];
                    } else if (id) {
                        // Update existing item
                        dataToSave[collectionName] = websiteContent[collectionName].map(p => p.id === id ? item : p);
                    } else {
                         // Add new item
                        dataToSave[collectionName] = [...websiteContent[collectionName], item];
                    }
                    break;
            }
             try {
                // Use a transaction to ensure atomic update of the array
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(contentRef);
                    if (!docSnapshot.exists()) {
                        throw "Document does not exist!";
                    }
                    
                    const currentData = docSnapshot.data();
                    let updatedData = { ...currentData };

                    if (context === 'book' || context === 'publication') {
                         const collectionName = context === 'book' ? 'books' : 'publications';
                         const item = dataToSave[collectionName].find(i => i.id === id || i.id.startsWith('new-'));
                         if (id && !id.startsWith('new-')) {
                             // Update existing item in the array
                             updatedData[collectionName] = currentData[collectionName].map(p => p.id === id ? item : p);
                         } else {
                             // Add new item to the array
                             updatedData[collectionName] = [...currentData[collectionName], item];
                         }
                    } else {
                         updatedData = { ...currentData, ...dataToSave };
                    }
                    transaction.update(contentRef, updatedData);
                });
                
                $('#edit-modal').classList.add('hidden');
                showToast('Changes saved successfully!');
            } catch (error) {
                console.error("Error saving document: ", error);
                showToast('Failed to save changes.', true);
            }
        });

        // Delete an item from an array
        async function deleteItem(collection, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/websiteContent`, "main");
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    if (!docSnapshot.exists()) {
                        throw "Document does not exist!";
                    }
                    const currentData = docSnapshot.data();
                    const updatedItems = currentData[collection].filter(item => item.id !== id);
                    transaction.update(docRef, { [collection]: updatedItems });
                });
                showToast('Item deleted successfully!');
            } catch (error) {
                console.error("Error deleting item: ", error);
                showToast('Failed to delete item.', true);
            }
        }

        // --- INITIALIZATION ---
        async function initializeWebsite() {
            // Check for existing content
            const docSnap = await getDoc(contentRef);
            if (!docSnap.exists()) {
                await setDoc(contentRef, defaultContent);
                console.log("Default content created.");
            }
            
            // Set up a real-time listener for content changes
            onSnapshot(contentRef, (doc) => {
                if (doc.exists()) {
                    websiteContent = doc.data();
                    renderWebsite();
                } else {
                    console.log("No such document!");
                }
            });
        }

        initializeWebsite();
    </script>










</body>
</html>